/* Portfolio Tracker - Data Management Module */

class DataManager {
  constructor() {
    this.latestStocks = [];
    this.latestMFHoldings = [];
    this.latestSIPs = [];
    this.latestPhysicalGold = [];
    this.latestFixedDeposits = [];
    this.latestFDSummary = [];
    this.lastRenderedJSON = "";
    this.lastRenderedMFJSON = "";
    this.lastRenderedSIPsJSON = "";
    this.lastRenderedPhysicalGoldJSON = "";
    this.lastRenderedFixedDepositsJSON = "";
    this.lastRenderedFDSummaryJSON = "";
  }

  async _fetchEndpoint(endpoint) {
    const response = await fetch(endpoint);
    return await response.json();
  }

  async fetchStocks() {
    return this._fetchEndpoint('/stocks_data');
  }

  async fetchMFHoldings() {
    return this._fetchEndpoint('/mf_holdings_data');
  }

  async fetchSIPs() {
    return this._fetchEndpoint('/sips_data');
  }

  async fetchPhysicalGold() {
    return this._fetchEndpoint('/physical_gold_data');
  }

  async fetchFixedDeposits() {
    return this._fetchEndpoint('/fixed_deposits_data');
  }

  async fetchFDSummary() {
    return this._fetchEndpoint('/fd_summary_data');
  }

  async fetchStatus() {
    return this._fetchEndpoint('/status');
  }

  async fetchAllData() {
    const [stocks, mfHoldings, sips, physicalGold, fixedDeposits, fdSummary, status] = await Promise.all([
      this.fetchStocks(),
      this.fetchMFHoldings(),
      this.fetchSIPs(),
      this.fetchPhysicalGold(),
      this.fetchFixedDeposits(),
      this.fetchFDSummary(),
      this.fetchStatus()
    ]);
    return { stocks, mfHoldings, sips, physicalGold, fixedDeposits, fdSummary, status };
  }

  _updateData(data, currentData, lastJSON, forceUpdate) {
    const dataJSON = JSON.stringify(data);
    if (dataJSON !== lastJSON || forceUpdate) {
      return { updated: true, newData: data, newJSON: dataJSON };
    }
    return { updated: false, newData: currentData, newJSON: lastJSON };
  }

  updateStocks(stocks, forceUpdate = false) {
    const result = this._updateData(stocks, this.latestStocks, this.lastRenderedJSON, forceUpdate);
    if (result.updated) {
      this.latestStocks = result.newData;
      this.lastRenderedJSON = result.newJSON;
    }
    return result.updated;
  }

  updateMFHoldings(mfHoldings, forceUpdate = false) {
    const result = this._updateData(mfHoldings, this.latestMFHoldings, this.lastRenderedMFJSON, forceUpdate);
    if (result.updated) {
      this.latestMFHoldings = result.newData;
      this.lastRenderedMFJSON = result.newJSON;
    }
    return result.updated;
  }

  updateSIPs(sips, forceUpdate = false) {
    const result = this._updateData(sips, this.latestSIPs, this.lastRenderedSIPsJSON, forceUpdate);
    if (result.updated) {
      this.latestSIPs = result.newData;
      this.lastRenderedSIPsJSON = result.newJSON;
    }
    return result.updated;
  }

  getStocks() {
    return this.latestStocks;
  }

  getMFHoldings() {
    return this.latestMFHoldings;
  }

  getSIPs() {
    return this.latestSIPs;
  }

  updatePhysicalGold(physicalGold, forceUpdate = false) {
    const result = this._updateData(physicalGold, this.latestPhysicalGold, this.lastRenderedPhysicalGoldJSON, forceUpdate);
    if (result.updated) {
      this.latestPhysicalGold = result.newData;
      this.lastRenderedPhysicalGoldJSON = result.newJSON;
    }
    return result.updated;
  }

  getPhysicalGold() {
    return this.latestPhysicalGold;
  }

  updateFixedDeposits(fixedDeposits, forceUpdate = false) {
    const result = this._updateData(fixedDeposits, this.latestFixedDeposits, this.lastRenderedFixedDepositsJSON, forceUpdate);
    if (result.updated) {
      this.latestFixedDeposits = result.newData;
      this.lastRenderedFixedDepositsJSON = result.newJSON;
    }
    return result.updated;
  }

  getFixedDeposits() {
    return this.latestFixedDeposits;
  }

  updateFDSummary(fdSummary, forceUpdate = false) {
    const result = this._updateData(fdSummary, this.latestFDSummary, this.lastRenderedFDSummaryJSON, forceUpdate);
    if (result.updated) {
      this.latestFDSummary = result.newData;
      this.lastRenderedFDSummaryJSON = result.newJSON;
    }
    return result.updated;
  }

  getFDSummary() {
    return this.latestFDSummary;
  }

  async triggerRefresh() {
    const response = await fetch('/refresh', { method: 'POST' });
    if (response.status !== 202) {
      const data = await response.json();
      throw new Error(data.error || 'Unknown error');
    }
    return await response.json();
  }
}

export default DataManager;
