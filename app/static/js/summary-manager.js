/* Portfolio Tracker - Summary Module */

import { Formatter } from './utils.js';

// Element ID constants
const ELEMENT_IDS = {
  STOCK: {
    INVESTED: 'total_invested',
    CURRENT: 'current_value',
    PL: 'total_pl',
    PL_PCT: 'total_pl_pct'
  },
  ETF: {
    INVESTED: 'etf_total_invested',
    CURRENT: 'etf_current_value',
    PL: 'etf_total_pl',
    PL_PCT: 'etf_total_pl_pct'
  },
  GOLD: {
    INVESTED: 'gold_total_invested',
    CURRENT: 'gold_current_value',
    PL: 'gold_total_pl',
    PL_PCT: 'gold_total_pl_pct'
  },
  SILVER: {
    INVESTED: 'silver_total_invested',
    CURRENT: 'silver_current_value',
    PL: 'silver_total_pl',
    PL_PCT: 'silver_total_pl_pct'
  },
  MF: {
    INVESTED: 'mf_total_invested',
    CURRENT: 'mf_current_value',
    PL: 'mf_total_pl',
    PL_PCT: 'mf_total_pl_pct'
  },
  FD: {
    INVESTED: 'fd_total_invested',
    MATURITY: 'fd_maturity_value',
    PL: 'fd_total_pl',
    PL_PCT: 'fd_total_pl_pct'
  },
  COMBINED: {
    INVESTED: 'combined_total_invested',
    CURRENT: 'combined_current_value',
    PL: 'combined_total_pl',
    PL_PCT: 'combined_total_pl_pct'
  }
};

class SummaryManager {
  /**
   * Update all summary cards with provided totals
   * @param {Object} stockTotals - { invested, current, pl, plPct }
   * @param {Object} etfTotals - { invested, current, pl, plPct } (excludes Gold/Silver ETFs)
   * @param {Object} goldTotals - { invested, current, pl, plPct }
   * @param {Object} silverTotals - { invested, current, pl, plPct }
   * @param {Object} mfTotals - { invested, current, pl, plPct }
   * @param {Object} fdTotals - { invested, maturity, returns, returnsPct }
   * @param {boolean} isUpdating - Whether refresh/update is in progress
   */
  updateAllSummaries(stockTotals, etfTotals, goldTotals, silverTotals, mfTotals, fdTotals, isUpdating = false) {
    // Provide default values if undefined
    const stock = stockTotals || { invested: 0, current: 0, pl: 0, plPct: 0 };
    const etf = etfTotals || { invested: 0, current: 0, pl: 0, plPct: 0 };
    const gold = goldTotals || { invested: 0, current: 0, pl: 0, plPct: 0 };
    const silver = silverTotals || { invested: 0, current: 0, pl: 0, plPct: 0 };
    const mf = mfTotals || { invested: 0, current: 0, pl: 0, plPct: 0 };
    const fd = fdTotals || { invested: 0, maturity: 0, returns: 0, returnsPct: 0 };

    // Calculate combined totals (FD maturity counts as "current")
    const combinedInvested = stock.invested + etf.invested + gold.invested + silver.invested + mf.invested + fd.invested;
    const combinedCurrent = stock.current + etf.current + gold.current + silver.current + mf.current + fd.maturity;
    const combinedPL = combinedCurrent - combinedInvested;
    const combinedPLPct = combinedInvested ? (combinedPL / combinedInvested * 100) : 0;

    // Calculate allocation percentages
    const stockAllocation = combinedInvested ? (stock.invested / combinedInvested * 100) : 0;
    const etfAllocation = combinedInvested ? (etf.invested / combinedInvested * 100) : 0;
    const goldAllocation = combinedInvested ? (gold.invested / combinedInvested * 100) : 0;
    const silverAllocation = combinedInvested ? (silver.invested / combinedInvested * 100) : 0;
    const mfAllocation = combinedInvested ? (mf.invested / combinedInvested * 100) : 0;
    const fdAllocation = combinedInvested ? (fd.invested / combinedInvested * 100) : 0;

    // Update allocation percentages
    this._updateAllocationPercentage('stocks_allocation_pct', stockAllocation);
    this._updateAllocationPercentage('etf_allocation_pct', etfAllocation);
    this._updateAllocationPercentage('gold_allocation_pct', goldAllocation);
    this._updateAllocationPercentage('silver_allocation_pct', silverAllocation);
    this._updateAllocationPercentage('mf_allocation_pct', mfAllocation);
    this._updateAllocationPercentage('fd_allocation_pct', fdAllocation);

    // Update all cards
    this._updateStockCard(stock);
    this._updateETFCard(etf);
    this._updateGoldCard(gold);
    this._updateSilverCard(silver);
    this._updateMFCard(mf);
    this._updateFDCard(fd);
    this._updateCombinedCard({
      invested: combinedInvested,
      current: combinedCurrent,
      pl: combinedPL,
      plPct: combinedPLPct
    });
  }

  _updateAllocationPercentage(elementId, percentage) {
    const el = document.getElementById(elementId);
    if (el) {
      el.innerText = percentage.toFixed(1) + '% ';
      
      // Set progress bar on parent card
      const card = el.closest('.card');
      if (card) {
        card.style.setProperty('--allocation-width', `${percentage}%`);
        
        // Set color based on card type
        let color = '#8b7765'; // default brown
        if (elementId === 'stocks_allocation_pct') {
          color = '#7c5cdb'; // purple
        } else if (elementId === 'etf_allocation_pct') {
          color = '#d94d8f'; // magenta
        } else if (elementId === 'mf_allocation_pct') {
          color = '#5ca0db'; // blue
        } else if (elementId === 'gold_allocation_pct') {
          color = '#d4af37'; // gold
        } else if (elementId === 'silver_allocation_pct') {
          color = '#c0c0c0'; // silver
        } else if (elementId === 'fd_allocation_pct') {
          color = '#5f9e8a'; // turtle green
        }
        card.style.setProperty('--allocation-color', color);
      }
    }
  }

  _updateStockCard(totals) {
    this._updateCard(
      ELEMENT_IDS.STOCK.INVESTED,
      ELEMENT_IDS.STOCK.CURRENT,
      ELEMENT_IDS.STOCK.PL,
      ELEMENT_IDS.STOCK.PL_PCT,
      totals
    );
  }

  _updateETFCard(totals) {
    this._updateCard(
      ELEMENT_IDS.ETF.INVESTED,
      ELEMENT_IDS.ETF.CURRENT,
      ELEMENT_IDS.ETF.PL,
      ELEMENT_IDS.ETF.PL_PCT,
      totals
    );
  }

  _updateGoldCard(totals) {
    this._updateCard(
      ELEMENT_IDS.GOLD.INVESTED,
      ELEMENT_IDS.GOLD.CURRENT,
      ELEMENT_IDS.GOLD.PL,
      ELEMENT_IDS.GOLD.PL_PCT,
      totals
    );
  }

  _updateSilverCard(totals) {
    this._updateCard(
      ELEMENT_IDS.SILVER.INVESTED,
      ELEMENT_IDS.SILVER.CURRENT,
      ELEMENT_IDS.SILVER.PL,
      ELEMENT_IDS.SILVER.PL_PCT,
      totals
    );
  }

  _updateMFCard(totals) {
    this._updateCard(
      ELEMENT_IDS.MF.INVESTED,
      ELEMENT_IDS.MF.CURRENT,
      ELEMENT_IDS.MF.PL,
      ELEMENT_IDS.MF.PL_PCT,
      totals
    );
  }

  _updateFDCard(totals) {
    // Fixed deposits use invested, maturity (instead of current), returns, returnsPct
    const investedEl = document.getElementById(ELEMENT_IDS.FD.INVESTED);
    const maturityEl = document.getElementById(ELEMENT_IDS.FD.MATURITY);
    const plEl = document.getElementById(ELEMENT_IDS.FD.PL);
    const plPctEl = document.getElementById(ELEMENT_IDS.FD.PL_PCT);

    if (!investedEl || !maturityEl || !plEl || !plPctEl) return;

    const invested = isNaN(totals.invested) ? 0 : totals.invested;
    const maturity = isNaN(totals.maturity) ? 0 : totals.maturity;
    const returns = isNaN(totals.returns) ? 0 : totals.returns;
    const returnsPct = isNaN(totals.returnsPct) ? 0 : totals.returnsPct;

    investedEl.innerText = Formatter.formatCurrencyForSummary(invested);
    maturityEl.innerText = Formatter.formatCurrencyForSummary(maturity);
    
    if (returns < 0) {
      plEl.innerText = '-' + Formatter.formatCurrencyForSummary(Math.abs(returns));
    } else {
      plEl.innerText = Formatter.formatCurrencyForSummary(returns);
    }
    plEl.style.color = Formatter.colorPL(returns);
    
    plPctEl.innerText = Formatter.formatPercentage(returnsPct);
    plPctEl.style.color = Formatter.colorPL(returns);
  }

  _updateCombinedCard(totals) {
    this._updateCard(
      ELEMENT_IDS.COMBINED.INVESTED,
      ELEMENT_IDS.COMBINED.CURRENT,
      ELEMENT_IDS.COMBINED.PL,
      ELEMENT_IDS.COMBINED.PL_PCT,
      totals
    );
  }

  _updateCard(investedId, currentId, plId, plPctId, totals) {
    const investedEl = document.getElementById(investedId);
    const currentEl = document.getElementById(currentId);
    const plEl = document.getElementById(plId);
    const plPctEl = document.getElementById(plPctId);

    // Safeguard against NaN values
    const invested = isNaN(totals.invested) ? 0 : totals.invested;
    const current = isNaN(totals.current) ? 0 : totals.current;
    const pl = isNaN(totals.pl) ? 0 : totals.pl;
    const plPct = isNaN(totals.plPct) ? 0 : totals.plPct;

    // Format invested, current, and P/L using summary currency formatter (respects compact toggle)
    investedEl.innerText = Formatter.formatCurrencyForSummary(invested);
    currentEl.innerText = Formatter.formatCurrencyForSummary(current);
    // Show '-' before currency for negative P/L
    if (pl < 0) {
      plEl.innerText = '-' + Formatter.formatCurrencyForSummary(Math.abs(pl));
    } else {
      plEl.innerText = Formatter.formatCurrencyForSummary(pl);
    }
    plEl.style.color = Formatter.colorPL(pl);
    // Show only one sign before percent value, use absolute value
    if (pl < 0) {
      plPctEl.innerText = '-' + Math.abs(plPct).toFixed(2) + '%';
    } else if (pl > 0) {
      plPctEl.innerText = '+' + Math.abs(plPct).toFixed(2) + '%';
    } else {
      plPctEl.innerText = '0.00%';
    }
    plPctEl.style.color = Formatter.colorPL(pl);
  }
}

export default SummaryManager;
